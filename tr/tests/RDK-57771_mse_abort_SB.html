<!DOCTYPE html>
<html>

<head>
    <meta charset='UTF-8' />
    <meta http-equiv='Cache-Control' content='no-cache, no-store, must-revalidate' />
    <meta http-equiv='Pragma' content='no-cache' />
    <meta http-equiv='Expires' content='0' />
    <title>SourceBuffer abort() test</title>
    <style>
        video {
            width: 50%;
            height: 50%;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: white;
            overflow: hidden;
        }
    </style>
    <script src="../lib/utils.js"></script>
    <script src="../lib/mse.js"></script>
</head>

<body>
    <script type='text/javascript'>
        const audioUrl = 'https://media.axprod.net/TestVectors/v7-Clear/15/'
        const videoUrl = 'https://media.axprod.net/TestVectors/v7-Clear/4/'
        const segmentTemp = "$Number$.m4s"
        const initSegmentTemp = "init.mp4"

        let video = null
        var ms, audioSb, videoSb;

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(startApp, 0)
        })

        function cleanup() {
            let srcUrl = video.src
            video.removeAttribute('src')
            video.load()
            video.remove()
            video = null
            window.URL.revokeObjectURL(srcUrl)
        }

        async function startApp() {
            video = document.createElement('video')
            document.body.appendChild(video)

            video.addEventListener('error', function (e) {
                reportFail('Test failed. Got an error: ' + video.error.code + ', ' + video.error.message)
                cleanup()
            })

            ms = await asyncPrepareMediaSource(video);

            if (_params["audio"] != 0)
                audioSb = await asyncPrepareSourceBuffer(ms, 'audio/mp4; codecs="mp4a.40.29"')
            if (_params["video"] != 0)
                videoSb = await asyncPrepareSourceBuffer(ms, 'video/mp4; codecs="avc1.640032"')

            audioSb && await asyncFetchAndAppend(ms, audioSb, audioUrl + initSegmentTemp)
            videoSb && await asyncFetchAndAppend(ms, videoSb, videoUrl + initSegmentTemp)
            audioSb && await asyncFetchAndAppend(ms, audioSb, audioUrl + segmentTemp.replace('$Number$', "1".padStart(4, "0")))
            videoSb && await asyncFetchAndAppend(ms, videoSb, videoUrl + segmentTemp.replace('$Number$', "1".padStart(4, "0")))

            checkTracks = () => {
                // We expect one video track and one audio track
                console.log("videoTracks: " + videoSb.videoTracks.length + ", audioTracks: " + audioSb.audioTracks.length)
                if (videoSb.videoTracks.length != 1 || audioSb.audioTracks.length != 1) {
                    reportFail("Tracks missing: video: " + videoSb.videoTracks.length + ", audio: " + audioSb.audioTracks.length)
                    cleanup();
                }
            }

            checkTracks();

            wait = (durationMs) => {
                return new Promise(resolve => setTimeout(resolve, durationMs));
            }

            video.ontimeupdate = () => {
                if (video.currentTime > 2) {
                    console.log("Abort() SourceBuffers and restart video; currTime: " + video.currentTime);
                    video.pause();
                    video.ontimeupdate = null;
                    setTimeout(async () => {
                        videoSb.abort()
                        audioSb.abort()
                        console.log("abort() done");

                        audioSb && await asyncFetchAndAppend(ms, audioSb, audioUrl + initSegmentTemp)
                        videoSb && await asyncFetchAndAppend(ms, videoSb, videoUrl + initSegmentTemp)

                        audioSb && await asyncFetchAndAppend(ms, audioSb, audioUrl + segmentTemp.replace('$Number$', "2".padStart(4, "0")))
                        videoSb && await asyncFetchAndAppend(ms, videoSb, videoUrl + segmentTemp.replace('$Number$', "2".padStart(4, "0")))

                        console.log("Play again");
                        video.play();
                        checkTracks();
                        video.ontimeupdate = () => {
                            if (video.currentTime > 5.5) {
                                video.ontimeupdate = null
                                reportPass("Playback restarted after SB abort(); currTime: " + video.currentTime);
                                cleanup();
                            }
                        }
                    }, 0);
                }
            }

            video.play();
        }
    </script>
</body>

</html>