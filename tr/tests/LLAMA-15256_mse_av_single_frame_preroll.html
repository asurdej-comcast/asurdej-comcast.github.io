<!DOCTYPE html>
<html>
<head>
  <script src="../lib/utils.js"></script>
  <script src="../lib/mse.js"></script>
  <script type="text/javascript">
    // This tests injects a single audio sample and video frame to allow preroll to complete.
    // It can be used to determine how much memory is used for seting up playback to provide a baseline.
    // Actual memory usage needs to be verified manually.
    //
    // test stream generated with:
    //
    // ffmpeg -f lavfi -r 30 -seek_timestamp 1 -ss 0 -i testsrc=1920*1080 -frames:v 1 -vf format=yuv420p -c:v libx264 -profile:v high -video_track_timescale 90000 -crf 18 -g 1 -movflags +faststart  video1920x1080.mpd
    // ffmpeg -f lavfi -seek_timestamp 1 -ss 0 -i "sine=f=1000\:d=30" -frames:a 1 -movflags +faststart  audio1kHz.mpd


    function log(message) {
          console.log(message);
          document.getElementById('console').innerHTML += message + "<br>";
    }

    async function runTestCase() {
        failTimeout(10, "Test case timed out (before preroll completed)");

        var mediaElement = document.getElementById("video");
        var mediaSource = null;
        var audioSourceBuffer = null;
        var videoSourceBuffer = null;

        const audioMimeType = 'audio/mp4; codecs="mp4a.40.2"';
        const videoMimeType = 'video/mp4; codecs="avc1.640028"';
        const audioAssetUrl = "../media/preroll/audio/";
        const videoAssetUrl = "../media/preroll/video/";
        const videoDuration = 0.023;

        mediaSource = await asyncPrepareMediaSource(mediaElement, duration=videoDuration, log);
        audioSourceBuffer = await asyncPrepareSourceBuffer(mediaSource, audioMimeType, null, log);
        videoSourceBuffer = await asyncPrepareSourceBuffer(mediaSource, videoMimeType, null, log);

        var audioData = []
        var videoData = []
        audioData[0] = await asyncFetchAB(audioAssetUrl + "init.mp4", log);
        audioData[1] = await asyncFetchAB(audioAssetUrl + "single_frame_segment.mp4", log);
        videoData[0] = await asyncFetchAB(videoAssetUrl + "init.mp4", log);
        videoData[1] = await asyncFetchAB(videoAssetUrl + "single_frame_segment.mp4", log);

        await asyncAppendDataToSourceBuffer(mediaSource, videoSourceBuffer, videoData[0], log);
        await asyncAppendDataToSourceBuffer(mediaSource, videoSourceBuffer, videoData[1], log);
        await asyncAppendDataToSourceBuffer(mediaSource, audioSourceBuffer, audioData[0], log);
        await asyncAppendDataToSourceBuffer(mediaSource, audioSourceBuffer, audioData[1], log);

        mediaSource.endOfStream();

        videoData = null;
        audioData = null;

        log("start play...");
        mediaElement.play();

        log("waiting for preroll...");
        await new Promise((resolve) => { mediaElement.onloadeddata = () => { resolve(); } });

        log("Preroll completed");

        resetFailTimeout();
        failTimeout(20, "Test case timed out");

        log("Delay completion to allow memory usage measurement...");
        await new Promise(resolve => setTimeout(resolve, 15000));

        reportPass("Preroll completed");
    }
  </script>
</head>
<body onload="runTestCase()" bgcolor="gray">
  <video id="video" style="float: right;" width="320" height="180" controls></video>
  <div id="console" style="font-size:10px"></div>
</body>
</html>
