<!DOCTYPE html>
<html>

<head>
    <meta charset='UTF-8' />
    <meta http-equiv='Cache-Control' content='no-cache, no-store, must-revalidate' />
    <meta http-equiv='Pragma' content='no-cache' />
    <meta http-equiv='Expires' content='0' />
    <title>MSE do seek before appending data buffers</title>
    <style>
        video {
            width: 50%;
            height: 50%;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: white;
            overflow: hidden;
        }
    </style>
    <script src="../lib/utils.js"></script>
    <script src="../lib/mse.js"></script>
</head>

<body>
    <script type='text/javascript'>
        const audioUrl = 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_a64k/bbb_a64k_$Number$.m4a'
        const videoUrl = 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps_1280x720_4000k/bbb_30fps_1280x720_4000k_$Number$.m4v'

        let video = null
        var ms, audioSb, videoSb;

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(startApp, 0)
        })


        function cleanup() {
            let srcUrl = video.src
            video.removeAttribute('src')
            video.load()
            video.remove()
            video = null
            window.URL.revokeObjectURL(srcUrl)
        }

        async function startApp() {
            video = document.createElement('video')
            document.body.appendChild(video)

            video.addEventListener('error', function (e) {
                reportFail('Test failed. Got an error: ' + video.error.code + ', ' + video.error.message)
                cleanup()
            })

            ms = await asyncPrepareMediaSource(video);
            var audioSb, videoSb;

            if (_params["audio"] != 0)
                audioSb = await asyncPrepareSourceBuffer(ms, 'audio/mp4; codecs="mp4a.40.2"')
            if (_params["video"] != 0)
                videoSb = await asyncPrepareSourceBuffer(ms, 'video/mp4; codecs="avc1.640028"')

            audioSb && await asyncFetchAndAppend(ms, audioSb, audioUrl.replace('$Number$', 0))
            videoSb && await asyncFetchAndAppend(ms, videoSb, videoUrl.replace('$Number$', 0))

            let seekTarget = 5;
            failTimeout(5, "Start playback after seek");
            video.ontimeupdate = () => {
                if (video.currentTime > seekTarget + 1) {
                    video.ontimeupdate = null;
                    resetFailTimeout();
                    reportPass("Playback started after seek");
                }}
            expectPositionProgress();
            video.currentTime = seekTarget
            video.play();

            audioSb && asyncFetchAndAppend(ms, audioSb, audioUrl.replace('$Number$', 2))
            videoSb && asyncFetchAndAppend(ms, videoSb, videoUrl.replace('$Number$', 2))
        }

        function expectPositionProgress() {
            var lastPosition = 0.0;
            let checkPositionIval = setInterval(() => {
                let currentTime = video.currentTime
                if (currentTime >= lastPosition)
                    lastPosition = currentTime;
                else
                    reportFail("Position moved back from " + lastPosition + " to " + currentTime)
            }, 0);
        }
    </script>
</body>

</html>